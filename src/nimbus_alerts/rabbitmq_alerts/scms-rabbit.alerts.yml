groups:
- name: scms-rabbit
  rules:
  # SLACK
  - alert: SCMSRabbitMQQueueHighSlack
    expr: rabbitmq_queue_messages_total > 1000
    for: 5m
    labels:
      monitored_item: '{{$labels.bosh_deployment}}/{{$labels.bosh_job_name}}'
      service: rabbitmq
      severity: scms
      spark: "false"
    annotations:
      description: The RabbitMQ Server queue at `{{$labels.instance}}` has over 1000 messages for over 5m
      summary: Rabbitmq Server instance queue `{{$labels.instance}}` is high

  - alert: SCMSRabbitMQMemAlarmSlack
    expr: rabbitmq_node_mem_alarm != 0
    for: 5m
    labels:
      monitored_item: '{{$labels.bosh_job_name}}'
      service: rabbitmq
      severity: scms
      spark: "false"
    annotations:
      description: The RabbitMQ Server instance at `{{$labels.instance}}` has locked
        due to high memory
      summary: Rabbitmq Server instance `{{$labels.instance}}` has locked

  - alert: SCMSRabbitMQCPUHigh
    expr: bosh_job_load_avg05{bosh_deployment="rabbitmq"} > 5
    for: 5m
    labels:
      monitored_item: '{{$labels.bosh_job_name}}'
      service: rabbitmq
      severity: scms
      spark: "false"
    annotations:
      description: The RabbitMQ Server instance at `{{$labels.instance}}` has high
        CPU - {{$value}}
      summary: 'Rabbitmq Server instance `{{$labels.instance}}` has high CPU: {{$value}}'

  - alert: SCMSRabbitMQMemoryHighSlack
    expr: rabbitmq_node_mem_limit * 0.3 - rabbitmq_node_mem_used < 0
    for: 5m
    labels:
      monitored_item: '{{$labels.bosh_deployment}}/{{$labels.bosh_job_name}}'
      service: rabbitmq
      severity: scms
      spark: "false"
    annotations:
      description: The RabbitMQ Server instance at `{{$labels.instance}}` has high
        memory for the last 5m
      summary: Rabbitmq Server instance `{{$labels.instance}}` is down

  - alert: SCMSRabbitMQOldMessagesCallout
    expr: min by(instance) (rabbitmq_up) != 1
    for: 5m
    labels:
      monitored_item: '{{$labels.bosh_deployment}}/{{$labels.bosh_job_name}}'
      service: rabbitmq
      severity: scms
      spark: "false"
    annotations:
      description: The RabbitMQ Server `{{$labels.instance}}` has a message older than 5 minutes
      summary: Rabbitmq Server instance `{{$labels.instance}}` is taking a long time to consume messages

  # CALLOUT
  - alert: SCMSRabbitMQQueueHighCallout
    expr: rabbitmq_queue_messages_total > 1000
    for: 5m
    labels:
      monitored_item: '{{$labels.bosh_deployment}}/{{$labels.bosh_job_name}}'
      service: rabbitmq
      severity: scms_callout
      spark: "true"
    annotations:
      description: The RabbitMQ Server queue at `{{$labels.instance}}` has over 1000 messages for over 5m
      summary: Rabbitmq Server instance queue `{{$labels.instance}}` is high

  - alert: SCMSRabbitMQOldMessagesCallout
    expr: min by(instance) (rabbitmq_up) != 1
    for: 5m
    labels:
      monitored_item: '{{$labels.bosh_deployment}}/{{$labels.bosh_job_name}}'
      service: rabbitmq
      severity: scms_callout
      spark: "true"
    annotations:
      description: The RabbitMQ Server `{{$labels.instance}}` has a message older than 5 minutes
      summary: Rabbitmq Server instance `{{$labels.instance}}` is taking a long time to consume messages
